<?php
/**
 * @package WordPress
 * @subpackage Traveler
 * @since 1.1.3
 * */
$paged = STInput::get('room_page', 1);
$item_id = get_the_ID();

extract($attr);
/**
 * Extract $attr to:
 * @param header_title
 * @param post_per_page
 * @param number_in_row
 * @param order_by
 * @param order
 * */
$query = array(
    'post_type' => 'rental_room',
    'posts_per_page' => $post_per_page,
    'orderby' => $order_by,
    'paged' => $paged,
    'order' => $order,
    'meta_query' => array(
        array(
            'key' => 'room_parent',
            'value' => $item_id,
            'compare' => '='
        )
    )
);
query_posts($query);
global $wp_query;

if (have_posts()):
    ?><div class="row">
        <div class="col-xs-12">
            <h4><?php echo __('Bedroom Distribution', ST_TEXTDOMAIN); ?></h4>
        </div>
        <div class="ars-rental-room-list clearfix" id="">
            <ul class="ars-rental-room-list-rooms">
                <?php
                while (have_posts()): the_post();
                    $room_post_id = get_the_ID();
                    $room_permalink = get_the_permalink();

                    $thumb_obj = wp_get_attachment_image_src(get_post_thumbnail_id($room_post_id), 'full');
                    ?>

                    <li class="ars-rental-room-list-rooms-item">
                        <div class="ars-rental-room-list-rooms-item-tn-container">
                        <div class="ars-rental-room-list-rooms-item-img-wrap st-popup-gallery">
                            <a href="<?php echo (!empty($thumb_obj[0])) ? $thumb_obj[0] : '#' ?>" class="st-gp-item">
                                <?php
                                if (has_post_thumbnail() and get_the_post_thumbnail()) {
                                    the_post_thumbnail(array(360, 270, 'bfi_thumb' => TRUE));
                                } else {
                                    echo st_get_default_image();
                                }
                                ?>
                            </a>
                            <?php
                            $count = 0;
                            $gallery = get_post_meta($room_post_id, 'gallery', TRUE);
                            $gallery = explode(',', $gallery);
                            if (!empty($gallery) and $gallery[0]) {
                                $count += count($gallery);
                            }
                            if ($count) {
                                echo '<div class="booking-item-img-num"><i class="fa fa-picture-o"></i>';
                                echo esc_attr($count);
                                echo '</div>';
                            }
                            ?>
                            <div class="hidden">
                                <?php
                                if (!empty($gallery) and $gallery[0]) {
                                    $count += count($gallery);
                                    foreach ($gallery as $key => $value) {
                                        $img_link = wp_get_attachment_image_src($value, array(800, 600, 'bfi_thumb' => TRUE));
                                        if (isset($img_link[0]))
                                            echo "<a class='st-gp-item' href='{$img_link[0]}'></a>";
                                    }
                                }
                                ?>
                            </div>
                        </div>
                            </div>
                        <div class="ars-rental-room-list-rooms-item-desc">
                            <h5 class="booking-item-title mt10"><a href="<?php echo esc_url($link); ?>" title=""><?php the_title() ?></a></h5>
                            <ul class="booking-item-features booking-item-features-sign clearfix mt10">
                                <?php if ($adult = get_post_meta(get_the_ID(), 'adult_number', true)): ?>
                                    <li rel="tooltip" data-placement="top" title="" data-original-title="<?php st_the_language('adults_occupany') ?>">
                                        <i class="fa fa-male"></i><span class="booking-item-feature-sign">x <?php echo esc_html($adult) ?></span>
                                    </li>
        <?php endif; ?>

                                <?php if ($child = get_post_meta(get_the_ID(), 'children_number', true)): ?>
                                    <li rel="tooltip" data-placement="top" title="" data-original-title="<?php st_the_language('childs') ?>">
                                        <i class="im im-children"></i><span class="booking-item-feature-sign">x <?php echo esc_html($child) ?></span>
                                    </li>
        <?php endif; ?>

                                <?php if ($bed = get_post_meta(get_the_ID(), 'bed_number', true)): ?>
                                    <li rel="tooltip" data-placement="top" title="" data-original-title="<?php st_the_language('bebs') ?>">
                                        <i class="im im-bed"></i><span class="booking-item-feature-sign">x <?php echo esc_html($bed) ?></span>
                                    </li>
        <?php endif; ?>

                                <?php if ($room_footage = get_post_meta(get_the_ID(), 'room_footage', true)): ?>
                                    <li rel="tooltip" data-placement="top" title="" data-original-title="<?php st_the_language('room_footage') ?>">
                                        <i class="im im-width"></i><span class="booking-item-feature-sign"><?php echo esc_html($room_footage) ?></span>
                                    </li>
                                    <?php
                                endif;
                                // other amenities (taxonomy)
                                $taxonomy = "room_amenities";
                                $terms = get_the_terms(get_the_ID(), $taxonomy);
                                if (is_array($terms) AND !empty($terms)) {
                                foreach ($terms as $key2 => $value2) {
                                    ?>
                                    <li rel="tooltip" data-placement="top" class="" title="" data-original-title="<?php echo esc_html($value2->name) ?>">
                                        <?php if (function_exists('get_tax_meta')): ?>
                                            <i class="<?php echo TravelHelper::handle_icon(get_tax_meta($value2->term_id, 'st_icon')) ?>"></i>
                                    <?php else: ?>
                                            <span class="booking-item-feature-title"><?php echo esc_html($value2->name) ?></span>
                                    <?php endif; ?>
                                    </li>
            <?php
                                }
                                
                                }
        ?>
                            </ul>
                        </div>
                    </li>
        <?php
    endwhile;
    ?></ul>
        </div>
    </div>
    <?php
endif;
wp_reset_postdata();
wp_reset_query();
?>